@page "/images/create/{ownerTypeName}/{ownerId:int}"
@rendermode InteractiveServer

@using RealEstateCMS.Services

@inject ApplicationDbContext DbContext
@inject FileUploadService FileUploadService
@inject NavigationManager Navigation

<PageTitle>Adaugă Imagine</PageTitle>

<div class="page-header">
    <h1>Adaugă Imagine</h1>
</div>

<div class="form-container">
    <EditForm Model="@image"
              OnValidSubmit="@HandleValidSubmit"
              FormName="CreateImageForm">

        <DataAnnotationsValidator />

        <!-- File input -->
        <div class="form-group">
            <label>Selectează imagine *</label>
            <InputFile OnChange="OnFileSelected"
                       accept="image/*"
                       class="form-control" />

            @if (!string.IsNullOrEmpty(fileError))
            {
                <div class="validation-message">@fileError</div>
            }
        </div>

        <!-- Preview -->
        @if (!string.IsNullOrEmpty(previewUrl))
        {
            <div class="form-group">
                <label>Previzualizare</label>
                <img src="@previewUrl"
                     style="max-width:300px; border-radius:6px;" />
            </div>
        }

        <!-- Alt text -->
        <div class="form-group">
            <label>Text alternativ</label>
            <InputText @bind-Value="image.AltText"
                       class="form-control" />
        </div>

        <!-- Primary -->
        <div class="form-group">
            <label>
                <InputCheckbox @bind-Value="image.IsPrimary" />
                Imagine principală
            </label>
        </div>

        <!-- Actions -->
        <div class="form-actions">
            <button type="submit"
                    class="btn btn-primary"
                    disabled="@(selectedFile == null || isUploading)">
                @(isUploading ? "Se încarcă..." : "Salvează")
            </button>

            <button type="button"
                    class="btn btn-secondary"
                    @onclick="Cancel">
                Anulează
            </button>
        </div>

        @if (!string.IsNullOrEmpty(errorMessage))
        {
            <div class="alert alert-danger">@errorMessage</div>
        }
    </EditForm>
</div>

@code {
    [Parameter] public string OwnerTypeName { get; set; } = string.Empty;
    [Parameter] public int OwnerId { get; set; }

    private Image image = new();
    private IBrowserFile? selectedFile;
    private string? previewUrl;
    private string? fileError;
    private string? errorMessage;
    private bool isUploading;

    protected override void OnInitialized()
    {
        if (!Enum.TryParse<OwnerType>(
                OwnerTypeName,
                true,
                out var parsedOwnerType))
        {
            Navigation.NavigateTo("/");
            return;
        }

        image.OwnerType = parsedOwnerType;
        image.OwnerId = OwnerId;
    }

    private async Task OnFileSelected(InputFileChangeEventArgs e)
    {
        fileError = null;
        selectedFile = e.File;

        if (selectedFile == null)
            return;

        image.FileName = selectedFile.Name;
        image.FilePath = "temp"; // needed for validation

        await CreatePreview();
    }

    private async Task CreatePreview()
    {
        try
        {
            var resized = await selectedFile!.RequestImageFileAsync(
                selectedFile.ContentType, 800, 800);

            using var stream = resized.OpenReadStream(5 * 1024 * 1024);
            using var ms = new MemoryStream();
            await stream.CopyToAsync(ms);

            previewUrl = $"data:{selectedFile.ContentType};base64,{Convert.ToBase64String(ms.ToArray())}";
        }
        catch
        {
            previewUrl = null;
        }
    }

    private async Task HandleValidSubmit()
    {
        if (selectedFile == null)
        {
            errorMessage = "Selectați o imagine.";
            return;
        }

        isUploading = true;
        errorMessage = null;

        try
        {
            var (success, filePath, uploadError) =
                await FileUploadService.UploadImageAsync(
                    selectedFile,
                    image.OwnerType.ToString().ToLower());

            if (!success)
            {
                errorMessage = uploadError;
                return;
            }

            image.FilePath = filePath!;
            image.UploadedAt = DateTime.Now;

            if (image.IsPrimary)
            {
                var existing = await DbContext.Images
                    .Where(i =>
                        i.OwnerType == image.OwnerType &&
                        i.OwnerId == image.OwnerId &&
                        i.IsPrimary)
                    .ToListAsync();

                foreach (var img in existing)
                    img.IsPrimary = false;
            }

            DbContext.Images.Add(image);
            await DbContext.SaveChangesAsync();

            Navigation.NavigateTo(GetRedirectUrl());
        }
        catch (Exception ex)
        {
            if (!string.IsNullOrEmpty(image.FilePath))
                FileUploadService.DeleteImage(image.FilePath);

            errorMessage = $"Eroare la salvare: {ex.Message}";
        }
        finally
        {
            isUploading = false;
        }
    }

    private void Cancel()
        => Navigation.NavigateTo(GetRedirectUrl());

    private string GetRedirectUrl() => image.OwnerType switch
    {
        OwnerType.Building => $"/buildings/edit/{OwnerId}",
        OwnerType.HouseType => $"/housetypes/edit/{OwnerId}",
        OwnerType.Plot => $"/plots/edit/{OwnerId}",
        _ => "/"
    };
}
